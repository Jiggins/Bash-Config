#!/bin/bash

# Checks if a command is installed
function commandExists {
  if command -v $1 > /dev/null; then
    return 0
  else
    return 1
  fi
}

function checkDependencies {
  dependencies=(
    git
    vim
    wget
  )

  for i in ${dependencies[*]}; do
    if ! commandExists $i; then
      dependenciesNotFound="${dependenciesNotFound}$i "
    fi
  done

  if [ ${dependenciesNotFound+x} ]; then
    echo 'The following dependencies are not installed on this system'
    echo -e "\n\t${dependenciesNotFound}\n"

    case `uname` in
      'Darwin')
        echo 'These can be installed using brew'

        if command -v brew > /dev/null; then
          echo 'brew is not installed on this system, consider installing brew and running this script again'
          echo 'http://brew.sh'
        else
          echo "brew install ${dependenciesNotFound}"
        fi
        ;;

      *)
        if commandExists apt-get; then
          echo -e "These can be installed using\n\n\tsudo apt-get install ${dependenciesNotFound}\n"
        elif commandExists yum; then
          echo -e "These can be installed using\n\n\tsudo yum install ${dependenciesNotFound}\n"
        else
          echo -e "These can be installed using your package manager to install: ${dependenciesNotFound}\n"
        fi
        ;;
    esac
    exit 1
  fi
}

# $1: File to prepend (Will appear at the top of $2)
# $2: File to prepend to (output file)
function prependFile {
  if [ ! $# -eq 2 ]; then
    echo 'prependFile expects two arguments:'
    echo '  $1: File to prepend (Will appear at the top of $2)'
    echo '  $2: File to prepend to (output file)'
    exit 1
  elif [ ! -e $2 ]; then
    verbose "Copying $1 to $2"
    cp $1 $2
  else
    verbose "Prepending $1 to $2"
    cp $1 tmp
    cat $2 >> tmp
    mv tmp $2
  fi

  return 0
}

function prependFileWithCheck {
  if [ ! -e $2 ] || ! grep -q 'configurations added by github.com/Jiggins/Bash-Config' $2; then
    prependFile $1 $2
  fi

  return 0
}

function verbose () {
  if [ ${VERBOSE+x} ]; then
    echo -e "$1"
  fi

  return 0
}

# Variables
BASHRC="${HOME}/.bashrc"
BASH_DIR="${HOME}/.config/bash"
GHCI="${HOME}/.ghci"
POWERLINE_DIR="${HOME}/.vim/bundle/powerline"
TMUX="${HOME}/.tmux.conf"
VIMRC="${HOME}/.vimrc"
VIM_DIR="${HOME}/.vim"
# VERBOSE='-v'

checkDependencies

# Install config directory
mkdir ${VERBOSE} -p ${HOME}/.config
mkdir ${VERBOSE} -p ${HOME}/.vim

cp ${VERBOSE} -r src/config/* ${HOME}/.config
cp ${VERBOSE} -r src/vim/* ${HOME}/.vim

# Install rcfiles
for f in src/rcfiles/*; do
  file=$(basename $f)
  prependFileWithCheck ${f} ${HOME}/.${file}
done

# Download Scripts
scripts=(
  https://raw.githubusercontent.com/jwiegley/git-scripts/master/git-forest
  https://raw.githubusercontent.com/whiteinge/dotfiles/master/bin/diffconflicts
)

if commandExists wget; then
  mkdir -p ${BASH_DIR}/scripts
  for i in ${scripts[*]}; do
    # --no-clobber - Don't download if script already exists
    # --directory-prefix - Download scripts to ~/.bash/scripts
    if [ ${VERBOSE+x} ]; then
      wget --no-clobber --directory-prefix=${BASH_DIR}/scripts $i
    else
      wget --no-clobber --quiet --directory-prefix=${BASH_DIR}/scripts $i
    fi
  done

  chmod +x ${BASH_DIR}/scripts/*

  # Powerline Fonts
  if [ ! -e ${HOME}/.fonts/ubuntu-mono-power ] && [ ! -e ${HOME}/.config/fontconfig/conf.d ]; then
    mkdir -p ${HOME}/.fonts/ubuntu-mono-power
    mkdir -p ${HOME}/.config/fontconfig/conf.d/
    wget --quiet https://github.com/powerline/powerline/raw/develop/font/PowerlineSymbols.otf -O ${HOME}/.fonts/PowerlineSymbols.otf
    wget --quiet https://github.com/powerline/powerline/raw/develop/font/10-powerline-symbols.conf -O ${HOME}/.config/fontconfig/conf.d/10-powerline-symbols.conf
    git clone https://github.com/pdf/ubuntu-mono-powerline-ttf.git ${HOME}/.fonts/ubuntu-mono-power > /dev/null
    fc-cache -vf ${HOME}/.config/fonts | grep 'fc-cache:'
    fc-cache -vf ${HOME}/.fonts | grep 'fc-cache:'
  fi
fi

# Bash completion for mac
if [ "$(uname)" == "Darwin" ]; then
  if commandExists brew; then
    if ! brew ls --version bash-completion > /dev/null; then
      brew install git bash-completion
    fi
  fi
fi

# Git configuration
if command -v git > /dev/null; then
  ./src/gitconfig
fi

#  Vi mode in ghci!
if ! grep -q "editMode vi" ${HOME}/.haskeline; then
  echo "editMode: Vi" >> ${HOME}/.haskeline
fi

# Installing Vim plugins
vi +PluginInstall +qall

# Transparent Monokai colorscheme
cp src/Monokai-Transparent.vim ${VIM_DIR}/bundle/vim-colorschemes/colors/

# Quick fix for invalid format option error caused by haskell-vim
# Odly Mac/FreeBSD takes an extra argument to sed, Ubuntu does not
verbose "Applying patch to ${VIM_DIR}/bundle/haskell-vim/after/ftplugin/haskell.vim"
case `uname` in
  'Darwin')
    sed -i '' '2s/ formatoptions+=j//' ${VIM_DIR}/bundle/haskell-vim/after/ftplugin/haskell.vim
    ;;
  *)
    sed -i '2s/ formatoptions+=j//' ${VIM_DIR}/bundle/haskell-vim/after/ftplugin/haskell.vim
esac

# Powerline installation
if commandExists pip; then
  export PATH="${PATH}:${HOME}/.config/bash/scripts"

  if [ ${VERBOSE+x} ]; then
    pip install --user --editable=${POWERLINE_DIR}
  else
    pip install -q --user --editable=${POWERLINE_DIR}
  fi

  # Symlink the powerline shell command to the bash scripts directore
  if [ ! -L ${BASH_DIR}/scripts/powerline ]; then
    ln -s ${POWERLINE_DIR}/scripts/* ${BASH_DIR}/scripts/
  fi
fi

source ${BASHRC}

exit 0
